# Claude Multi Starter (CMS) - 项目功能清单

## 📋 项目概述

**项目名称**: Claude Multi Starter (CMS)  
**核心功能**: 多实例 Claude CLI 启动与协作管理工具  
**主要用途**: 在 WezTerm 终端中同时运行多个独立的 Claude 实例，实现 AI 助手的协同工作

---

## 🎯 核心功能模块

### 1️⃣ **多实例管理系统**

#### 1.1 实例配置管理
- **配置文件**: `.cms_config/cms.config`
- **功能描述**: 
  - 定义多个 Claude 实例（支持1-12个）
  - 为每个实例设置角色（UI设计师、开发者、测试工程师等）
  - 配置实例自动启动选项
  - 支持自定义会话文件路径

**保留建议**: ✅ **必须保留** - 核心配置系统

#### 1.2 实例启动器
- **主要脚本**: 
  - `START_MULTI_TAB.py` - 多标签页启动
  - `lib/multi_daemon_launcher.py` - 多守护进程启动
  - `bin/start-claude` - 单实例启动命令
  
- **功能特性**:
  - 一键启动所有配置的实例
  - 支持选择性启动指定实例
  - 自动检测并配置 WezTerm 环境
  - 三种布局模式：窗格(pane)、窗口(window)、标签页(tab)

**保留建议**: ✅ **必须保留** - 核心启动功能

---

### 2️⃣ **实例间通信系统**

#### 2.1 Send 命令 - 即时消息发送
- **脚本**: `bin/send`, `bin/send.cmd`
- **功能描述**:
  - 向指定实例发送即时消息
  - 自动解析实例映射关系
  - 支持三种映射模式（pane/window/tab）
  
**使用示例**:
```bash
send ui "设计登录页面"
send coder "实现用户认证API"
send test "测试登录功能"
```

**保留建议**: ✅ **必须保留** - 实例通信核心功能

#### 2.2 Ask 命令 - 异步任务请求
- **脚本**: `bin/ask`
- **功能描述**:
  - 发送后台异步任务请求
  - 支持任务超时设置
  - 提供通知模式（--notify）
  - 生成唯一任务ID追踪

**保留建议**: ⚠️ **可选保留** - 如果需要异步任务功能则保留

#### 2.3 Pend 命令 - 任务状态查询
- **脚本**: `bin/pend`
- **功能描述**:
  - 查询异步任务执行状态
  - 获取任务返回结果

**保留建议**: ⚠️ **可选保留** - 配合 ask 命令使用

#### 2.4 Ping 命令 - 实例健康检查
- **脚本**: `bin/ping`
- **功能描述**:
  - 检测实例是否在线
  - 验证实例响应状态

**保留建议**: ⚠️ **可选保留** - 监控和诊断工具

---

### 3️⃣ **窗口布局管理系统**

#### 3.1 网格布局计算
- **模块**: `lib/multi_instance_layout.py`
- **功能描述**:
  - 根据实例数量自动计算最优布局
  - 支持多种网格：1x1, 1x2, 2x2, 3x2, 4x2, 3x3等
  - 智能分割方向计算（横向/纵向）

**布局策略**:
- 1个实例: 1x1
- 2个实例: 1x2 (并排)
- 3-4个: 2x2 网格
- 5-6个: 3x2 网格
- 7-8个: 4x2 网格
- 9+个: 3x3 或更大网格

**保留建议**: ✅ **必须保留** - 多窗口布局核心

#### 3.2 映射文件管理
- **映射文件**:
  - `pane_mapping.json` - 窗格ID映射
  - `window_mapping.json` - 窗口ID映射
  - `tab_mapping.json` - 标签页ID映射
  
- **功能描述**:
  - 自动检测并保存窗格/窗口/标签ID
  - 建立实例ID到物理窗口的映射关系
  - 确保消息路由到正确的目标

**保留建议**: ✅ **必须保留** - 通信路由必需

---

### 4️⃣ **会话管理系统**

#### 4.1 会话文件隔离
- **模块**: `lib/claude_session_resolver.py`, `lib/session_utils.py`
- **功能描述**:
  - 每个实例维护独立会话文件
  - 会话文件命名：`.claude-{instance_id}-session`
  - 上下文隔离，避免实例间混淆

**保留建议**: ✅ **必须保留** - 多实例独立运行必需

#### 4.2 会话注册表
- **模块**: `lib/pane_registry.py`
- **功能描述**:
  - 注册所有活跃会话
  - 跟踪会话状态和元数据
  - 提供会话查找和清理功能
  - TTL过期清理（默认7天）

**保留建议**: ✅ **推荐保留** - 会话管理和状态追踪

---

### 5️⃣ **终端环境支持**

#### 5.1 WezTerm 终端检测
- **模块**: `lib/detect_wezterm.py`, `lib/terminal.py`
- **功能描述**:
  - 自动检测 WezTerm 终端环境
  - 验证 WezTerm CLI 可用性
  - 获取当前窗格/窗口/标签信息

**保留建议**: ✅ **必须保留** - WezTerm 集成核心

#### 5.2 跨平台支持
- **模块**: `lib/compat.py`, `lib/env_utils.py`
- **功能描述**:
  - Windows 编码处理
  - 标准输入/输出兼容
  - 环境变量管理

**保留建议**: ✅ **必须保留** - 跨平台兼容性

#### 5.3 WSL 后端支持
- **模块**: `lib/cms_config.py`
- **功能描述**:
  - Windows 访问 WSL 中的 Claude 会话
  - 自动检测 WSL 发行版和 Home 目录
  - 会话路径映射（\\wsl.localhost\）

**保留建议**: ⚠️ **可选保留** - 仅 WSL 用户需要

---

### 6️⃣ **通信协议系统**

#### 6.1 CMS 协议
- **模块**: `lib/cms_protocol.py`, `lib/claude_comm.py`
- **功能描述**:
  - 定义实例间通信协议格式
  - 消息封装和解析
  - 协议标记处理

**保留建议**: ⚠️ **可选保留** - 如果使用自定义协议则保留

---

### 7️⃣ **MCP 服务器集成**

#### 7.1 跨提供商委托服务器
- **路径**: `mcp/cms-delegation/server.py`
- **功能描述**:
  - MCP (Model Context Protocol) 服务器实现
  - 支持多个 AI 提供商：Codex, Gemini, Claude, OpenCode
  - 提供统一的 ask/pend/ping 接口
  - 任务结果缓存（TTL 24小时）

**工具别名**:
- `cask`, `cpend`, `cping` - Codex
- `gask`, `gpend`, `gping` - Gemini  
- `lask`, `lpend`, `lping` - Claude
- `oask`, `opend`, `oping` - OpenCode

**保留建议**: ❌ **可删除** - 除非需要跨 AI 提供商集成

---

### 8️⃣ **辅助工具和脚本**

#### 8.1 安装脚本
- **文件**: `install.cmd`, `install.ps1`
- **功能**: 项目初始化和依赖安装

**保留建议**: ✅ **推荐保留** - 部署和安装便利

#### 8.2 项目ID管理
- **模块**: `lib/project_id.py`
- **功能**: 计算项目唯一标识符

**保留建议**: ⚠️ **可选保留**

#### 8.3 进程锁管理
- **模块**: `lib/process_lock.py`
- **功能**: 防止重复启动

**保留建议**: ⚠️ **可选保留**

#### 8.4 清理守护进程
- **脚本**: `lib/cleanup-daemons.ps1`
- **功能**: 清理僵尸进程

**保留建议**: ⚠️ **可选保留** - 维护工具

#### 8.5 修复映射工具
- **脚本**: `fix-mapping.py`
- **功能**: 修复或重建映射文件

**保留建议**: ⚠️ **可选保留** - 故障修复工具

#### 8.6 国际化支持
- **模块**: `lib/i18n.py`
- **功能**: 多语言界面支持

**保留建议**: ⚠️ **可选保留** - 如不需要多语言可删除

#### 8.7 命令补全
- **脚本**: `bin/cms-completion-hook`
- **功能**: Shell 命令补全支持

**保留建议**: ⚠️ **可选保留** - 提升用户体验

#### 8.8 挂载检测
- **脚本**: `bin/cms-mounted`
- **功能**: 检查 CMS 是否正确挂载

**保留建议**: ⚠️ **可选保留**

#### 8.9 配置同步
- **脚本**: `bin/sync-config`
- **功能**: 同步配置文件

**保留建议**: ⚠️ **可选保留**

---

## 🗂️ 文档系统

### 用户文档
- `README.md` - 英文主文档
- `README_cn.md` - 中文主文档  
- `USER_GUIDE.md` - 详细使用指南（641行）
- `SETUP.md` - 快速设置指南
- `README_USAGE.md` - 使用说明

**保留建议**: ✅ **推荐保留主要文档**，可合并精简

---

## 📊 功能保留优先级总结

### 🔴 必须保留（核心功能）
1. **实例配置系统** (`.cms_config/cms.config`)
2. **多实例启动器** (`START_MULTI_TAB.py`, `multi_daemon_launcher.py`)
3. **Send 通信命令** (`bin/send`)
4. **窗口布局管理** (`multi_instance_layout.py`)
5. **映射文件系统** (pane/window/tab_mapping.json)
6. **会话隔离** (`claude_session_resolver.py`)
7. **WezTerm 集成** (`detect_wezterm.py`, `terminal.py`)
8. **跨平台兼容** (`compat.py`)
9. **主要文档** (README, SETUP)

### 🟡 推荐保留（增强功能）
1. **会话注册表** (`pane_registry.py`)
2. **安装脚本** (install.*)
3. **用户指南** (USER_GUIDE.md)

### ⚪ 可选保留（根据需求）
1. **Ask/Pend/Ping 命令** - 如需异步任务
2. **MCP 服务器** - 如需跨 AI 提供商集成
3. **WSL 支持** - 仅 Windows+WSL 用户
4. **CMS 协议** - 如需自定义通信协议
5. **辅助工具** - 按需保留

### ❌ 可删除（非必需）
1. **国际化模块** (`i18n.py`) - 如只用一种语言
2. **命令补全** - 如不需要 shell 补全
3. **重复文档** - 可合并精简

---

## 💡 精简建议

### 最小核心版本（仅保留必需功能）
```
保留文件：
- START_MULTI_TAB.py
- bin/send, send.cmd
- lib/multi_daemon_launcher.py
- lib/multi_instance_layout.py  
- lib/claude_session_resolver.py
- lib/detect_wezterm.py
- lib/terminal.py
- lib/compat.py
- lib/cms_start_config.py
- lib/providers.py
- README.md, SETUP.md
- .cms_config/cms.config (配置)
```

### 标准版本（推荐配置）
在最小核心版本基础上增加：
```
- bin/ask, pend, ping (异步任务)
- lib/pane_registry.py (会话管理)
- lib/session_utils.py
- install.cmd, install.ps1
- USER_GUIDE.md
```

### 完整版本（保留所有功能）
保持当前所有文件，适合需要全部功能的场景

---

## 🎯 使用场景分析

### 场景1: 简单多实例协作
**需求**: 2-4个实例，基本通信  
**保留**: 最小核心版本  
**删除**: MCP服务器、异步任务、国际化

### 场景2: 专业团队模拟
**需求**: 多角色分工、任务追踪  
**保留**: 标准版本  
**删除**: MCP服务器、WSL支持（如不需要）

### 场景3: 企业级多AI集成  
**需求**: 多个AI提供商、高级功能  
**保留**: 完整版本  
**删除**: 无

---

## 📝 决策建议

**请根据以下问题决定保留哪些功能：**

1. ❓ 是否需要异步任务功能（ask/pend）？
2. ❓ 是否需要跨 AI 提供商集成（MCP）？
3. ❓ 是否在 Windows+WSL 环境使用？
4. ❓ 实例数量通常是多少？（<4 或 >4）
5. ❓ 是否需要多语言界面？
6. ❓ 是否需要 shell 命令补全？

**根据答案选择对应版本即可！**
