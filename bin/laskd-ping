#!/usr/bin/env python3
"""
laskd-ping - Check if laskd daemon is running for a specific instance
"""
import sys
import os
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

from compat import setup_windows_encoding
setup_windows_encoding()

try:
    from laskd_daemon import ping_daemon, read_state
    from providers import get_claude_instance
    from askd_runtime import state_file_path

    def main() -> int:
        instance_id = os.environ.get("CCB_CLAUDE_INSTANCE", "default")
        inst_spec = get_claude_instance(instance_id)
        state_file = state_file_path(inst_spec.state_file_name)

        # Try to read state first
        try:
            st = read_state(state_file)
            if not st:
                print(f"DOWN - No state file (instance: {instance_id})")
                return 1
        except Exception as e:
            print(f"DOWN - Cannot read state: {e} (instance: {instance_id})")
            return 1

        # Try to ping daemon
        try:
            if ping_daemon(timeout_s=0.5, state_file=state_file):
                print(f"UP - Daemon running (instance: {instance_id}, port: {st.get('port', 'unknown')})")
                return 0
            else:
                print(f"DOWN - Daemon not responding (instance: {instance_id})")
                return 1
        except Exception as e:
            print(f"DOWN - Ping failed: {e} (instance: {instance_id})")
            return 1

    if __name__ == "__main__":
        sys.exit(main())

except ImportError as e:
    print(f"[ERROR] Module import failed: {e}")
    sys.exit(1)
