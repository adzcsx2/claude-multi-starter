#!/usr/bin/env python3
"""
pend - View latest reply from AI providers.

Usage:
    pend <provider> [N] [--session-file FILE]

Providers:
    gemini, codex, opencode, droid, claude

Arguments:
    N    Show the latest N conversations (default: 1)
"""

import sys
import os
import subprocess
from pathlib import Path

script_dir = Path(__file__).resolve().parent


# Provider to original pend command mapping
PROVIDER_PENDS = {
    "gemini": "gpend",
    "codex": "cpend",
    "opencode": "opend",
    "droid": "dpend",
    "claude": "lpend",
}

# Known Claude instances (will be populated from providers.py if available)
_CLAUDE_INSTANCES = ["default"]


def _resolve_claude_target(target: str) -> tuple[str, str | None]:
    """
    Resolve Claude target to (provider, instance_id)

    Returns:
        (provider, instance_id)

    Examples:
        "claude" -> ("claude", None)
        "alpha" -> ("claude", "alpha")
        "claude:alpha" -> ("claude", "alpha")
        "beta" -> ("claude", "beta")
    """
    if ":" in target:
        provider, instance = target.split(":", 1)
        if provider.lower() == "claude":
            return ("claude", instance)
        return (provider.lower(), None)

    if target in _CLAUDE_INSTANCES:
        return ("claude", target)

    if target in PROVIDER_PENDS:
        return (target, None)

    return (target, None)


def _usage():
    print("Usage: pend <provider|instance> [N] [--session-file FILE]", file=sys.stderr)
    print("", file=sys.stderr)
    print("Providers:", file=sys.stderr)
    print("  gemini, codex, opencode, droid, claude", file=sys.stderr)
    print("", file=sys.stderr)
    print("Claude Instances:", file=sys.stderr)
    print("  default, alpha, beta, ... (configured in ccb.config)", file=sys.stderr)
    print("", file=sys.stderr)
    print("Arguments:", file=sys.stderr)
    print("  N    Show the latest N conversations (default: 1)", file=sys.stderr)


def main():
    if len(sys.argv) < 2:
        _usage()
        return 1

    target = sys.argv[1].lower()

    if target in ("-h", "--help"):
        _usage()
        return 0

    # Add lib to path for importing providers
    lib_dir = script_dir.parent / "lib"
    sys.path.insert(0, str(lib_dir))

    # Try to load Claude instances from providers.py
    try:
        from providers import list_claude_instances, is_claude_instance
        _CLAUDE_INSTANCES.extend([i for i in list_claude_instances() if i != "default"])
    except Exception:
        pass

    # Resolve target to provider, instance_id
    provider, instance_id = _resolve_claude_target(target)

    if provider not in PROVIDER_PENDS:
        print(f"[ERROR] Unknown provider: {target}", file=sys.stderr)
        print(f"[ERROR] Available: {', '.join(PROVIDER_PENDS.keys())}", file=sys.stderr)
        if _CLAUDE_INSTANCES != ["default"]:
            print(f"[ERROR] Available Claude instances: {', '.join(_CLAUDE_INSTANCES)}", file=sys.stderr)
        return 1

    # Get the original pend command
    pend_cmd = PROVIDER_PENDS[provider]
    pend_path = script_dir / pend_cmd

    if not pend_path.exists():
        print(f"[ERROR] Command not found: {pend_path}", file=sys.stderr)
        return 1

    # Set instance_id in environment for Claude instances
    if instance_id and instance_id != "default":
        os.environ["CCB_CLAUDE_INSTANCE"] = instance_id

    # Pass remaining arguments to the original command
    cmd = [str(pend_path)] + sys.argv[2:]

    try:
        result = subprocess.run(cmd)
        return result.returncode
    except Exception as e:
        print(f"[ERROR] {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())
