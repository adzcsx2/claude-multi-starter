# 🚀 自动触发通信使用指南

## ✨ 核心功能

**C1完成任务 → 自动触发C2 → C2完成 → 自动触发C3 → C3完成 → 自动触发C1**

完全自动化的工作流程，无需人工切换窗口！

---

## 📋 工作原理

### 方式1: Claude窗口内自动触发（推荐）

每个窗口完成任务后，会**自动执行send命令**触发下一个窗口：

```
C1窗口执行完毕
  ↓
执行: python bin/send c2 "继续"
  ↓
C2窗口自动收到"继续"命令
  ↓
C2开始执行任务
  ↓
C2执行完毕
  ↓
执行: python bin/send c3 "继续"
  ↓
C3窗口自动收到"继续"命令
  ↓
...循环
```

### 方式2: 手动发送命令（调试用）

在任何终端窗口执行：

```bash
# 触发C2开始工作
python bin/send c2 "继续"

# 触发C3开始测试
python bin/send c3 "继续"

# 发送自定义消息
python bin/send c1 "请设计一个用户登录页面"
python bin/send c2 "请实现登录API"
python bin/send c3 "请测试登录功能"
```

---

## 🎯 快速开始

### 1. 启动自动化环境

```bash
.\start-automation.bat
```

这会打开：

- **Windows Terminal** - 3个标签页 (C1/C2/C3)
- **Auto-continue窗口** - 监控状态变化

### 2. 在每个标签页启动Claude

**C1标签页 (Design):**

```
我是 C1 窗口，负责设计任务。启动自动化模式。
```

**C2标签页 (Main):**

```
我是 C2 窗口，负责开发任务。启动自动化模式。
```

**C3标签页 (Test):**

```
我是 C3 窗口，负责测试任务。启动自动化模式。
```

### 3. 开始第一个任务

在C1窗口输入：

```
继续
```

之后就全自动了！

---

## 🔄 自动化流程详解

### 当前任务状态

查看 `task-comms/automation-state.md`:

```markdown
## Current State

- **Current Step**: STEP_DESIGN
- **Current Window**: C1
- **Current Task**: 用户登录功能

## Task List

- [x] 0. 计算器功能 ✅ 完成
- [ ] 1. 用户登录功能
- [ ] 2. 数据导出功能
```

### C1 (设计窗口) 执行流程

1. ✅ 读取 `automation-state.md`
2. ✅ 检查 `Current Window == C1`
3. ✅ 执行设计任务
4. ✅ 更新状态文件：
   - `Current Step: STEP_DEVELOP`
   - `Current Window: C2`
5. ✅ **自动执行**: `python bin/send c2 "继续"`
6. ✅ 显示：`✅ 任务完成！已自动触发 C2 窗口开始工作`

### C2 (开发窗口) 执行流程

1. ✅ **自动收到**: "继续" 命令
2. ✅ 读取 `automation-state.md`
3. ✅ 检查 `Current Window == C2`
4. ✅ 执行开发任务
5. ✅ 更新状态文件：
   - `Current Step: STEP_TEST`
   - `Current Window: C3`
6. ✅ **自动执行**: `python bin/send c3 "继续"`
7. ✅ 显示：`✅ 任务完成！已自动触发 C3 窗口开始测试`

### C3 (测试窗口) 执行流程

1. ✅ **自动收到**: "继续" 命令
2. ✅ 读取 `automation-state.md`
3. ✅ 检查 `Current Window == C3`
4. ✅ 执行测试任务
5. ✅ 更新状态文件：
   - `Current Step: STEP_DESIGN`
   - `Current Window: C1`
   - `Current Index: 2` (下一个任务)
6. ✅ **自动执行**: `python bin/send c1 "继续"`
7. ✅ 显示：`✅ 任务完成！已自动触发 C1 窗口开始下一个任务`

---

## 🛠️ send 命令详解

### 基本用法

```bash
python bin/send <窗口名> <消息>
```

### 可用窗口名

- `c1` - 设计窗口
- `c2` - 开发窗口
- `c3` - 测试窗口

### 示例命令

```bash
# 自动触发（最常用）
python bin/send c2 "继续"
python bin/send c3 "继续"

# 发送任务
python bin/send c1 "设计一个用户登录页面，包含用户名、密码输入框和记住我选项"
python bin/send c2 "实现用户登录API，使用JWT认证"
python bin/send c3 "编写登录功能的单元测试和集成测试"

# 发送提示
python bin/send c2 "注意：这个功能需要支持OAuth2.0"
python bin/send c3 "请额外测试密码强度验证"
```

### 工作原理

1. 读取 `.cms_config/tab_mapping.json` 获取窗口ID
2. 使用 Windows Terminal CLI 发送文本到目标标签页
3. 自动添加回车符，触发命令执行

---

## 📊 状态监控

### 实时查看状态

```bash
# 方式1: 查看状态文件
type task-comms\automation-state.md

# 方式2: 运行状态查看器
.\show-status.bat

# 方式3: 运行监控脚本
.\scripts\watch-automation.ps1
```

### 状态文件位置

- **自动化状态**: `task-comms/automation-state.md`
- **C1输出**: `task-comms/from-c1-design.md`
- **C2输出**: `task-comms/from-c2-main.md`
- **C3输出**: `task-comms/from-c3-test.md`

---

## 🎓 使用场景

### 场景1: 批量界面开发

```
任务列表:
- [ ] 1. 登录页面
- [ ] 2. 首页
- [ ] 3. 个人中心
- [ ] 4. 设置页面

流程:
C1设计登录页 → C2实现 → C3测试 →
C1设计首页 → C2实现 → C3测试 →
C1设计个人中心 → ...
```

### 场景2: 功能迭代

```
C1: 分析需求，设计架构
  ↓ (自动触发)
C2: 实现功能代码
  ↓ (自动触发)
C3: 运行测试，发现问题
  ↓ (自动触发)
C1: 分析问题，优化设计
  ↓ (自动触发)
C2: 修复代码
  ↓ ...循环直到完成
```

### 场景3: 手动干预

```bash
# C3发现严重bug，立即通知C2
python bin/send c2 "紧急：发现登录接口会泄露密码，请立即修复"

# C1需要C2提供技术细节
python bin/send c2 "请说明当前使用的加密算法"

# 跳过某个窗口，直接触发下一个
python bin/send c1 "继续"
```

---

## ⚠️ 注意事项

1. **必须在Windows Terminal中运行**
   - send命令依赖Windows Terminal CLI
   - WezTerm等其他终端不支持

2. **确保标签页正确映射**
   - 映射文件: `.cms_config/tab_mapping.json`
   - 启动时自动生成

3. **Claude必须在等待输入状态**
   - 如果Claude正在处理任务，send命令会排队
   - 确保前一个命令完成后再发送下一个

4. **状态文件同步**
   - 所有窗口共享同一个状态文件
   - 避免手动编辑状态文件

---

## 🔧 故障排查

### send命令无响应

```bash
# 1. 检查映射文件
type .cms_config\tab_mapping.json

# 2. 检查Windows Terminal是否运行
tasklist | findstr WindowsTerminal

# 3. 重新启动自动化环境
.\start-automation.bat
```

### 窗口收不到消息

```bash
# 1. 确认窗口名正确
python bin/send c1 "test"  # 小写
python bin/send C1 "test"  # 大写也可以

# 2. 检查窗口是否在运行
# 切换到对应标签页查看

# 3. 查看send输出
python bin/send c2 "test"
# 应该看到: [OK] Sent to c2 (tab xxx)
```

### 自动触发失败

检查Claude是否正确执行了send命令：

```
# Claude应该显示类似输出：
[OK] Sent to c2 (tab 1)
✅ 任务完成！已自动触发 C2 窗口开始工作
```

如果没有，检查：

1. bin/send 文件是否存在
2. Python是否在PATH中
3. 映射文件是否正确

---

## 📚 相关文档

- [MULTI_WINDOW_GUIDE.md](project-guide/MULTI_WINDOW_GUIDE.md) - 多窗口协同完整指南
- [AUTOMATION_GUIDE.md](project-guide/AUTOMATION_GUIDE.md) - 自动化详细说明
- [task-queue.md](task-queue.md) - 任务队列系统

---

**享受全自动的协作开发体验！** 🎉
